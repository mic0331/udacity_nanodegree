---
title: "Data Analysis with R"
author: "Michaël Lambé (mic0331 AT gmail DOT com)"
date: "Last edited, Thursday, April 30, 2015"
output:
  html_document:
    toc: true
    highlight: default
    theme: united
  pdf_document: default
geometry: margin=1in
fontsize: 10pt
---

<style type="text/css">

#TOC {
  position: fixed;
  left: 0;
  top: 0;
  width: 250px;
  height: 100%;
  overflow:auto;
}
#TOC ul li a {
  color: #777;
}
body {
  max-width: 1600px;
  margin: auto;
  margin-left:260px;
  line-height: 20px;
}
</style>

[Github Source Code](https://github.com/mic0331/udacity_nanodegree/tree/master/P3)

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9, packages}

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

#install.packages("RSQLite")  # if needed
#install.packages("freqweights") # if needed
#install.packages('reshape2') # if needed
#install.packages("ggmap") # if needed
#install.packages("xtable") # if needed

library(knitr)
library(dplyr)
library(reshape2)
require(ggplot2)
library(gridExtra)
library(grid)
library(scales)
library(freqweights)
library(maps)
library(GGally)
library(lubridate)
library(xtable)

opts_knit$set(root.dir = '/Users/mic0331/Documents/TRAINING/Data Analysis/Courses/Nanodegree Data Analyst/Projects/udacity_nanodegree/P3/data')
```

# Introduction

## Abstract

Taking an airplane is one of the most important and efficient ways to travel. 
However, many travelers have experienced delayed flight. Which airline carriers 
delayed most often? Which airports have highest probability to make you wait for 
a long time? Also, which day of week and which month of year are better for your 
journey without severe delay?

The aim of this presentation is to provide statistics accompanied by charts and discussions to better understand the dataset.

For this project, we will be exploring the airline on-time performance from a 
publicly available dataset from the stat-computing website (see reference at 
the end of this document).

## The dataset

The data consists of flight arrival and departure details for all commercial 
flights within the USA, from October 1987 to April 2008. 

The dataset is packed in a yearly chunks from 1987 to 2008.  This is a large 
dataset: there are nearly 120 million records in total, and takes up 1.6 
gigabytes of space compressed and 12 gigabytes when uncompressed. 

To make sure we will be not overwhelmed by the size of the data, we will create 
a subset file that will be used for our Exploratory Data Analysis task.

For a deeper exaplanation about the data preparation and the SQL code, please 
refer to [this page](Data_preparation.html) where every steps are explained 
in details.

```{r}
rita = read.csv('./rita.csv')
dim(rita)
# also lead other utilitiy files
airports = read.csv('./airports.csv')
carriers = read.csv('./carriers.csv')
```

There are 800,000 flights from 1997 till 2008 with 32 features.

```{r}
str(rita)
```

The data comes originally from 
[RITA](http://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp) 
where it is 
[described in detail](http://www.transtats.bts.gov/Fields.asp?Table_ID=236).

Here is a summary of these features:

```{r}
columns = read.csv('./columns.csv', sep=";")
columns
```

Two features has been built on top of the existing to facilitate the 
exploration exercice.

First, the feature `speed` has been created, the calculation behind this variable 
is very simple, we take the distance and divide by the `AirTime` (flight time) 
variable (in hours).  This give us the speed in miles / hour.  

Next, the feature `date` has also been created to simply reflect the departure 
date in a date format.  We use this format because the data set only offer the 
data as three separate features (Year, Month, DayOfMonth)

```{r}
# We adjust the date features formats
rita$Month <- sprintf("%02d", rita$Month)
rita$DepTime <- sprintf("%04d", rita$DepTime)
rita$ArrTime <- sprintf("%04d", rita$ArrTime)
rita$DayOfWeek <- sprintf("%02d", rita$DayOfWeek)
rita$DayofMonth <- sprintf("%02d", rita$DayofMonth)

# speed in miles / hour
rita <- mutate(rita, speed = Distance / (AirTime / 60))

# full date of the departure
rita <- mutate(rita, date = as.Date(paste(rita$Year, rita$Month, 
                                          rita$DayofMonth, sep=""), "%Y%m%d"))
```

Note: 

  - Reason for cancellation can take 4 possible value (A = carrier, B = weather, 
  C = NAS, D = security).
  
  - We have 29 carriers in the dataset.
  
  - We have 335 destination airports and 333 origin airports.
  
  - The delays in the dataset is measured in minutes, we will often convert this
  unit in hours based on the analysis we want to perform.

# Plotting delayed, cancelled, on-time, boarding ... Flying in the USA

## Range analysis

It is effective to devide the numeric variable into the ordered, reasonable 
range for our analysis. So we split the `Distance, ArrDelay, Airtime, 
CRSDepTime, CRSArrTime` respectively and make sure that all the observation is 
included in given range.

The split of the data is made based on the observation of the output from the
`summary` command.  This commande provide the five-number summary, a concise 
summary of the distribution of the observations.  With that we have an 
information about the location (from the median), the spread (from the 
quartiles) and the range (from the sample minimum and maximum) of the 
observations.

```{r}
data = rita
```

1/ Distance of flights in miles

```{r, echo=TRUE}
summary(rita$Distance)
```

The data distribution is left (positive) skewed.  We can see that the mean is 
larger than the median.

```{r}
data$Distance = ordered(cut(data$Distance, c(0, 300, 600, 1000, Inf)), 
                        labels = c("Short", "Medium", "Long", "Too long"))

ggplot(data, aes(x=Distance)) +
  geom_histogram(fill="lightblue") +
  theme_bw()
```

Most flights are coverining medium distance.  The number of long and short 
distance are comparable.

2/ Arrival delays in minutes

```{r, echo=TRUE}
summary(rita$ArrDelay)
```

```{r}
data$ArrDelay = ordered(cut(data$ArrDelay, c(0, 25, 50, 80, Inf)), 
                        labels = c("On-Time", "Delayed", "Intermediate-Delayed",
                                   "Much-Delayed"))

ggplot(data, aes(x=ArrDelay)) +
  geom_histogram(fill="lightblue") +
  theme_bw()
```

Besides the NA values, most of the flights land on-time.
We have 16745 NA's in the dataset for this variable. 

3/ Flight time

```{r, echo=TRUE}
summary(rita$AirTime)
```

```{r}
data$AirTime = ordered(cut(data$AirTime, c(-1, 50, 100, 200, 300, Inf)), 
                       labels = c("Too-Short", "Short", "Intermediate", 
                                  "Long", "Too-Long"))

ggplot(data, aes(x=AirTime)) +
  geom_histogram(fill="lightblue") +
  theme_bw()
``` 

Most flight are short in time (less than an hour) or intermediate (from one to 
2 hours); long flight (more than 3 hours) are less frequent.

4/ Scheduled departure time (CRS is the Computer Reservation System) 

```{r, echo=TRUE}
summary(rita$CRSDepTime)
```

```{r}
data$CRSDepTime = ordered(cut(data$CRSDepTime, c(-1, 600, 1200, 1800, Inf)), 
                          labels = c("Overnight", "Morning", "Afternoon", 
                                     "Evening"))

ggplot(data, aes(x=CRSDepTime)) +
  geom_histogram(fill="lightblue") +
  theme_bw()
```

Most of the flights are scheduled during the morning or afternoon and less 
frequently the evening.

5/ Scheduled arrival time (CRS is the Computer Reservation System) 

```{r, echo=TRUE}
summary(rita$CRSArrTime)
```

```{r}
data$CRSArrTime = ordered(cut(data$CRSArrTime, c(-1, 600, 1200, 1800, 2359)), 
                          labels = c("Overnight", "Morning", "Afternoon", 
                                     "Evening"))

ggplot(data, aes(x=CRSArrTime)) +
  geom_histogram(fill="lightblue") +
  theme_bw()
```

Most flights land the afternoon and the evening.  This make sence based on the 
previous histogram.

## Airline companies

```{r, fig.height=10, fig.width=10}
merged.data <- merge(data, carriers, by.x="UniqueCarrier", by.y="Code")

qplot(x = UniqueCarrier, data = merged.data, fill = Description) +
  theme_bw() +
  coord_flip() +
  xlab(NULL) +
  guides(fill=guide_legend(ncol=2)) +
  theme(legend.position="none")
```

The chart show major US airlines (in number of flights), we can see major 
companies such American Airlines, Delta, United.

For reference, we provide a glossary of abbreviations.  Also note that America 
West Airlines inc. and US Airways Inc. has been merged in October 2007.

```{r xtable, results="asis"}
merged.data.unique_carrier <- unique(merged.data[,c('UniqueCarrier', 'Description')])
row.names(merged.data.unique_carrier)<-NULL

print(xtable(merged.data.unique_carrier), type="html", include.rownames=F)
```

## Flight volume

Let's show the number of flight (flight volume) we have per year.

```{r}
rita.rita_per_year <- subset(rita, Year > 1987) %>%
  group_by(Year) %>%
  summarise(n = n()) %>%
  arrange(Year)

ggplot(rita.rita_per_year) +
  geom_point(aes(x=Year, y=n)) +
  geom_line(aes(x=Year, y=n), col = "lightblue") +
  scale_x_continuous(limits = c(1988, 2008), breaks = seq(1987, 2008, 5)) +
  ylab("Count") +
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(colour = "black", linetype = 3, size = .5),
    panel.background = element_blank(),
    axis.title.x = element_text(size=16),
    axis.text.x = element_text(size=14, angle=45, hjust=1, vjust=1),
    axis.title.y = element_text(size=16, angle = 90),
    axis.text.y = element_text(size=14),
    strip.background = element_rect(color="white", fill="white"),
    strip.text = element_text(size=16)
  )

# This is a different way to visualize the same information.
#ggplot(rita, aes(x = Year)) + 
#  geom_histogram(fill="lightblue", binwidth=1, col="black") +
#  labs(title = "Distribution of flight per year") + 
#  xlab('Year') +
#  theme_bw()
```

We see from this plot a continuity in the growth of number of flight.  There are
less flight in the 80th than in the 2008.  This is algin with a logical thinking
and also the size of the files used to load the database.  We removed the year 
1987 because we only have the 3 last months of that year.

With that we can assume the random selection of the sample has been made 
correctly and we are not privileging a year over another.

We see a drop in the number of fligh between 2001 and 2003, probably due to the 
event of September 11, 2001, however, flight volume is on the increase - 
dramatically so since 2000.

## Delays Arrival / Departure

Let's now focus the analysis on the delays.
The next four plots are showing on the left the number (up) and the density 
(down) of departure delay and on the right the same for arrival delay.

```{r, message=FALSE, warning=FALSE}
p1 <- ggplot(rita, aes(x=DepDelay / 60)) +
  geom_histogram(fill="lightblue", binwidth=.1) + 
  scale_x_continuous(limits = c(-2, 2), breaks = seq(-2, 2, 1)) +
  geom_vline(aes(xintercept=mean(DepDelay / 60, na.rm=T)),   # Ignore NA values for mean
               color="red", linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(DepDelay / 60, na.rm=T)),   # Ignore NA values for median
               color="green", linetype="dashed", size=.5) +
  xlab('Departure Delays (hours)') +
  theme_bw()

p2 <- ggplot(rita, aes(x=ArrDelay / 60)) +
  geom_histogram(fill="lightblue", binwidth=.1) + 
  scale_x_continuous(limits = c(-2, 2), breaks = seq(-2, 2, 1)) +
  geom_vline(aes(xintercept=mean(ArrDelay / 60, na.rm=T)),   # Ignore NA values for mean
               color="red", linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(ArrDelay / 60, na.rm=T)),   # Ignore NA values for median
               color="green", linetype="dashed", size=.5) +
  xlab('Arrival Delays (hours)') +
  theme_bw()

p3 <- ggplot(rita, aes(x=DepDelay / 60)) +
  geom_histogram(fill="lightblue", binwidth=.1, aes(y = ..density..), 
                 color = "black") + 
  geom_density(color="black") +
  scale_x_continuous(limits = c(-2, 2), breaks = seq(-2, 2, 1)) +
  geom_vline(aes(xintercept=mean(DepDelay / 60, na.rm=T)),   # Ignore NA values for mean
               color="red", linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(DepDelay / 60, na.rm=T)),   # Ignore NA values for median
               color="green", linetype="dashed", size=.5) +
  xlab('Departure Delays (hours)') +
  theme_bw()

p4 <- ggplot(rita, aes(x=ArrDelay / 60)) +
  geom_histogram(fill="lightblue", binwidth=.1, aes(y = ..density..), 
                 color = "black") + 
  geom_density(color="black") +
  scale_x_continuous(limits = c(-2, 2), breaks = seq(-2, 2, 1)) +
  geom_vline(aes(xintercept=mean(ArrDelay / 60, na.rm=T)),   # Ignore NA values for mean
               color="red", linetype="dashed", size=.5) +
  geom_vline(aes(xintercept=median(ArrDelay / 60, na.rm=T)),   # Ignore NA values for median
               color="green", linetype="dashed", size=.5) +
  xlab('Arrival Delays (hours)') +
  theme_bw()

grid.arrange(p1, p2, p3, p4, ncol = 2)
```

We see that most flight have no delays.  The distribution for the departure 
seems a bit negatively skewed compare to arrival where the distribution is normal.

```{r, message=FALSE, warning=FALSE, fig.height=10}
rita.no_missing <- filter(rita, !is.na(DepDelay) & !is.na(ArrDelay))
rita.by_year <- group_by(rita.no_missing, Year)

# the *1.0 is used to avoid loss of precision when attemting to convert a 
# numeric to an integer

rita.DepDelays <- summarise(rita.by_year,
                    mean = mean(DepDelay, na.rm = TRUE),
                    median = median(DepDelay * 1.0, na.rm = TRUE),
                    q75 = quantile(DepDelay, .75, na.rm = TRUE),
                    q25 = quantile(DepDelay, .25, na.rm = TRUE),
                    over_15 = mean(DepDelay > 15, na.rm = TRUE),
                    over_30 = mean(DepDelay > 30, na.rm = TRUE),
                    over_60 = mean(DepDelay > 60, na.RM = TRUE))

rita.ArrDelays <- summarise(rita.by_year,
                    mean = mean(ArrDelay, na.rm = TRUE),
                    median = median(ArrDelay * 1.0, na.rm = TRUE), 
                    q75 = quantile(ArrDelay, .75, na.rm = TRUE),
                    q25 = quantile(ArrDelay, .25, na.rm = TRUE),
                    over_15 = mean(ArrDelay > 15, na.rm = TRUE),
                    over_30 = mean(ArrDelay > 30, na.rm = TRUE),
                    over_60 = mean(ArrDelay > 60, na.RM = TRUE))

p1 <- ggplot(rita.DepDelays, aes(x = factor(Year), y = mean)) +
  geom_bar(stat = "identity", fill="lightblue") +
  geom_line(aes(y=q75, group=1, color="red")) +
  geom_point(aes(y=q75)) +
  geom_line(aes(y=q25, group=1, color="blue")) +
  geom_point(aes(y=q25)) +
  geom_line(aes(y=median, group=1, color="yellow")) +
  geom_point(aes(y=median)) +
  scale_color_manual("Quartile",labels = c("Q25 % (lower quartile)", 
                                           "Q75 % (upper quantile)", "median"), 
                     values = c("blue", "red", "yellow")) +
  xlab('Year') +
  ggtitle('Departure') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = .5, vjust=0.5)) +
  theme(legend.position="bottom", legend.direction = "horizontal")

p2 <- ggplot(rita.ArrDelays, aes(x = factor(Year), y = mean)) +
  geom_bar(stat = "identity", fill="lightblue") +
  geom_line(aes(y=q75, group=1, color="red")) +
  geom_point(aes(y=q75)) +
  geom_line(aes(y=q25, group=1, color="blue")) +
  geom_point(aes(y=q25)) +
  geom_line(aes(y=median, group=1, color="yellow")) +
  geom_point(aes(y=median)) +
  scale_color_manual("Quartile",labels = c("Q25 % (lower quartile)", 
                                           "Q75 % (upper quantile)", "median"), 
                     values = c("blue", "red", "yellow")) +
  xlab('Year') +
  ggtitle('Arrival') +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = .5, vjust=0.5)) +
  theme(legend.position="bottom", legend.direction = "horizontal")

# npc = normalised parent coordinates - basically analogous to a proportion of 
# the plot area, so values range from 0 to 1
grid.arrange(p1, p2, ncol = 1, heights=unit(.5, "npc"))
```

The first quartile is at the 25th percentile, we see a clear drop in this 
quartile and an increase of the upper quantile (75%).  This means that we have 
less and less of the data smaller than the first quartile so a substential 
increase of the delay year after year.  This is true for both departure and 
arrival but certainly more pronounced for departure.

## Diverted / Cancelled flights

```{r}
rita.diverted <- rita %>%
  group_by(Diverted) %>%
  summarise(n = n())

rita.diverted$Diverted <- factor(rita.diverted$Diverted, 
                 levels = c(0,1), 
                 labels = c("No", "Yes"))

ggplot(data=rita.diverted, aes(x=Diverted,y=n)) + 
  geom_bar(stat="identity") +
  scale_y_log10() +
  theme_bw() +
  labs(y = "count (log)")
```

In this dataset, we have almost all flight not diverted

```{r}
rita.cancelled <- rita %>%
  group_by(Cancelled) %>%
  summarise(n = n())

rita.cancelled$Cancelled <- factor(rita.cancelled$Cancelled, 
                 levels = c(0,1), 
                 labels = c("No", "Yes"))

ggplot(data=rita.cancelled, aes(x=Cancelled,y=n)) + 
  geom_bar(stat="identity") +
  scale_y_log10() +
  theme_bw() +
  labs(y = "count (log)")
```

Also, not many flight cancelled.  

We have access to the cancellation code, let's see the proportion of 
cancellation code.

```{r}
rita$Cancelled <- factor(rita$Cancelled, 
                 levels = c(0,1), 
                 labels = c("No", "Yes"))
rita.rita_cancellation_code <- filter(rita, !is.na(CancellationCode) & 
                                        Cancelled == "Yes")

rita.rita_cancellation_code$CancellationCode <- 
  factor(rita.rita_cancellation_code$CancellationCode, 
                 levels = c("A","B","C","D"), 
                 labels = c("Carrier", "Weather", "NAS", "Security"))

barplot(prop.table(table(rita.rita_cancellation_code$CancellationCode)))
```

## Airports

Let's look at the number of flights per destination.

```{r, message=FALSE, warning=FALSE}
ggplot(rita, aes(x = Dest)) +
    geom_bar() +
    labs(x = "Destination",
         y = "Number of Flights") +
    theme_bw()
```

There are way too many destinations.  In this case, the best thing to do is 
subset to the top 10 destinations.

```{r}
rita.flights <- rita %>%
    group_by(Dest) %>%
    summarise(flight_count = n(), plane_count = n_distinct(TailNum)) %>%
    arrange(desc(flight_count))

rita.flight_top_50 <- head(rita.flights, n=50)
```

```{r}
ggplot(rita.flight_top_50[1:10, ], aes(x = Dest, weight = flight_count)) +
    geom_bar() +
    labs(x = "Destination",
         y = "Number of Flights") +
    theme_bw()
```

Since we've already got the top destinations in a table format with the number 
of plane, it's a good opportunity to display a visualization of these two 
variables.

```{r}
ggplot(rita.flight_top_50[1:20, ], aes(x = Dest, y = flight_count)) + 
  geom_point(fill="lightblue", aes(size=plane_count)) +
  labs(title = "Number of flights for the top 20 destination airports") + 
  xlab('Number of flights') +
  theme_bw() +
  theme(legend.position="bottom")
```

No susprise, the airports with the highest number of plane are those having the 
highest number of flights.

## Distance

We will show the distribution of the distance for each flight.

```{r, message=FALSE, warning=FALSE}
ggplot(rita, aes(x = Distance)) +
  geom_histogram() +
  theme_bw()
```

The histogram of distance is left skewed so I'm going to transform the data 
using a log transform.

```{r, message=FALSE, warning=FALSE}
p1 <- qplot(data = rita, x = Distance, binwidth = 100, fill = I("#099DD9")) +
  ggtitle('Distance')

p2 <- qplot(data = rita, x = Distance, binwidth = .01, fill = I("#F79420")) +
  ggtitle('Distance (log10)') +
  scale_x_log10()

grid.arrange(p1, p2, ncol = 2)
```

I log-transformed the left skewed distance distribution.  However this 
transformation does not provide any added value or sence to the data.

## Correlation analysis

Due to my computer limits, for the next operation I only selected 100 flights.

```{r eval=FALSE}
# sample 100 flights from the data set
set.seed(20150422)
rita.rita_samp <- rita[sample(1:length(rita$speed), 100), ]

ggpairs(rita.rita_samp[, c('DayOfWeek', 'Year', 'AirTime', 'ArrDelay', 
                           'DepDelay', 'speed', 'Distance', 
                           'CarrierDelay', 'NASDelay', 'LateAircraftDelay')], 
        lower=list(continuous="smooth", params=c(colour="blue")),
  diag=list(continuous="bar", params=c(colour="blue")), 
  upper=list(params=list(corSize=12)), axisLabels='show') +
  theme(legend.position = "none", 
        panel.grid.major = element_blank(), 
        axis.ticks = element_blank(), 
        axis.text = element_blank(),
        panel.border = element_rect(linetype = "dashed", colour = "black", 
                                    fill = NA))
```

 <img src="pictures/ggpairs.jpeg" height="1400px" width="1300px" />

From this plot we see that we don't have a lot of obvious correlation between 
features however, let's look at some of them.

## speed and distance

For large scale commercial airplane, speed in flight is 500 MPH.  
Let's use 600 MPH as a limit.

As speed increase, the distance increase.  This makes a lot of sence.  
The relationship between speed and distance appears to be exponential rather 
than linear.

```{r}
rita.rita_speed_distance = subset(rita, rita$speed >= 0 & rita$speed <= 600)

p <- ggplot( data = rita.rita_speed_distance, aes(x=speed, y=Distance)) +
  geom_point() +
  xlim(0, 600) +
  theme_bw()

m1 <- lm(Distance ~ speed, data = rita.rita_speed_distance, na.action=na.omit)
p + geom_abline(m1$intercept, m1$slope, colour = "red")
#summary(m1)
#print(m1)
```

With a basic linear model, we have an $R^2$ value of .4549 therefore, speed 
explains about 45 percent of the variance in distance.
The fitted regression line is : Distance = -1221.7 + 4.922 speed.  According to 
this model, average distance increases by 4.922 miles for each additional mile
per hour of speed.

The residuals are the vertical distances from the observed distance to the line.

The residual plot (see billow) has some unisually large residuals labeled; observations 
222924 for example.  We also observe that residuals are closer to zero at low 
distances; the variance of the residuals is not constant across all speed, but 
increasing with speed.

```{r}
results = data.frame(speed=300)
results$m1 <- predict(m1, results)
```

If we try to predict the distance for a speed of 300 mph, we got a flight 
distance of 255 miles.

For inference, we requires some asumptions about the distribution of the error 
term.  We assume that the random errors are independant and indentically 
distributed as Normal random variables.  

Residual plots help us to assess the fit of the model and the assumptions 
for the error.

Here we are requested two plots: a plot of residuals vs fit and a QQ plot to 
check for normality of residuals.

```{r}
plot(m1, which=1:2)
```

In the residual plot a curve has been added.  This curve is a fitted lowess 
(local polynomial regression) curve, called a smoother.  The residuals are 
assummed independant and identivally distributed, but there is a pattern evident.
The residuals have a "U" shape or bowl shape.  This pattern could indicate that 
there is a variable missing from the model.  In the QQ plot, normally 
distributed residuals should lie approximately along the reference line shown in
the plot.  We clearly see that this is not really the case.  Therefore, our 
model regression model is not really a good fit for predicting distance of 
flight for a given speed.

Let's try an exponential regression.

```{r}
results <- data.frame(speed = seq(300, 600, by = 50))
m2 <- lm(Distance ~ speed + I(speed^2), data = rita.rita_speed_distance, 
         na.action=na.omit)
m3 <- lm(Distance ~ speed + I(speed^2) + I(speed^3), 
         data = rita.rita_speed_distance, na.action=na.omit)
m4 <- lm(Distance ~ I(speed^2), data = rita.rita_speed_distance, 
         na.action=na.omit)

results$m2 <- predict(m2, results)
results$m3 <- predict(m3, results)
results$m4 <- predict(m4, results)

results <-  melt(results, id.vars = "speed", variable.name = "model",
                value.name = "fitted")

ggplot(results, aes(x = speed, y = fitted)) +
  xlim(0, 600) +  
  geom_point(data = rita.rita_speed_distance, aes(x = speed, y = Distance)) +
  geom_line(aes(colour = model), size = 1) +
  theme_bw()
```

We are testing 3 different kind of models respectively
  * m2 : Distance ~ speed + I(speed^2)
  * m3 : Distance ~ speed + I(speed^2) + I(speed^3)
  * m4 : Distance ~ I(speed^2)

With the model m3 we have an $R^2$ of 52.7%  which is much better.  

Also the residual plot has a line shape but still the QQplot normally 
distributed residuals does not lie along the reference line shown in the plot.

```{r, echo=TRUE}
#summary(m3)
plot(m3, which=1:2)
```

Finally, let's look at the speed vs distance with less overplotting.

```{r}
rita.rita_speed_distance.average <- rita.rita_speed_distance
rita.rita_speed_distance.average$speed <- round(
  rita.rita_speed_distance.average$speed,
  digits=-1)

rita.rita_speed_distance.average <- rita.rita_speed_distance.average %>%
  group_by(speed) %>%
  summarise(mean = mean(Distance))

ggplot(data = rita.rita_speed_distance, aes(x=speed, y=Distance)) +
  geom_point(alpha = 1/10, position = position_jitter(h = 0)) +
  geom_line(data = rita.rita_speed_distance.average, 
            aes(x=speed, y=mean), color = 'red') +
  xlim(0, 600) +
  theme_bw()
```

From this last plot we start to see something interesting, we see several 
points which are disconnected from the main dots.
This probably show different kind of plane.  We start to see 3 exponentionals 
curves.  
The red line depict the average over the distance values for each speed value.

## Best day to travel

```{r}
rita$DayOfWeek <- factor(rita$DayOfWeek, 
                 levels = c('01','02','03','04','05','06','07'), 
                 labels = c("Monday", "Tuesday", "Wednesday", 
                            "Thursday", "Friday", "Saterday", "Sunday"))
rita.per_day <- rita %>%
  group_by(date, DayOfWeek) %>%
  summarise(count = n())

ggplot(rita.per_day, aes(x = DayOfWeek, y = count)) + 
  geom_boxplot() +
  stat_summary(fun.y=mean, geom="point", shape=5, size=4) +
  stat_summary(fun.y=mean, geom="line", aes(group=1), color = 'red')  + 
  stat_summary(fun.y=mean, geom="point", color = 'red') +
  theme_bw()
```

The plot suggest that the number of flight are similar with respect to variance, 
but with possibly different centers (different location).  The Saterday and Friday
are farther apart that the Tuesday and Wednesday for example, but it is not easy 
to tell from the plot if these differences are significant.  Let us compare the 
means and standard deviations of the 7 groups.

```{r}
meansd = function(x) c(mean=mean(x), sd=sd(x))
by(rita.per_day$count, rita.per_day$DayOfWeek, FUN=meansd)
```

The standard deviations are close for the seven groups, which we observed from the
boxplots.  However, the means of the groups are also close; 

Are there "significant" differences among the means ?

We can answer this question by conducting a quick One-way ANOVA test.  In this 
case, the null hypothesis is that the mean of number of flight is equal for the 
seven days of the weeks.

The R `oneway.test` function is a simple way to obtain the one-way analysis of 
variance. It is valid if certain conditions are satisfied: the errors are
$NID(0,\sigma^2)$, where “NID” is an abbreviation for “normally distributed and
independent.” The symbol $\sigma^2$ is the error variance, and stating that errors
are $NID(0,\sigma^2)$ also means that the variance of random error is equal for 
all groups. In the `oneway.test` function, there is an adjustment made (to degrees
of freedom for error) for unequal variance. Normal error distribution
can be checked using Normal-QQ plots of residuals.

```{r}
L = lm(rita.per_day$count ~ rita.per_day$DayOfWeek)
qqnorm(L$res)
qqline(L$res, col='red')
```

In the Normal-QQ plot the residuals should lie approximately along the reference
line. The plots do not reveal any severe departure from the assumptions
for this model.

Let's now perform the One-way ANOVA test :

```{r}
oneway.test(rita.per_day$count ~ rita.per_day$DayOfWeek, var.equal=TRUE)
```

Just looking at the p-value (< 2.2e-16), we can conclude to reject $H_0$ at 5% 
significance.

We see Saterday and Sunday are two days with less delay, Saterday is the day with
less flights in general. Let's look more closely.

```{r}
rita.year_day_of_week <- rita %>%
  group_by(Year, DayOfWeek) %>%
  summarise(ArrDelay_mean = mean(ArrDelay * 1.0, na.rm=T),
            ArrDelay_median = median(ArrDelay * 1.0, na.rm=T),
            n = n()) %>%
  arrange(Year, DayOfWeek)

ggplot(rita.year_day_of_week, aes(x=Year, y=ArrDelay_mean)) +
  geom_line(aes(colour=DayOfWeek)) +
  ylab('Arrival Delay (min)') +
  theme_bw()
```

Best days to travel and avoid delays are Saturdays, Sunday but also Tuesdays or 
Wednesdays. Fridays are bad for delays.
Also note the pick than the drop arround 2001, this is probably representative 
to the 9/11 event.

Next, we can visualize the number of flight for each months with a separation 
between the weekend and weekday.  We will do this exercice for the year 2008.

```{r, fig.height=8, fig.width=10}
rita.per_day_month <- subset(rita, Year == 2008) %>%
  group_by(Month, DayofMonth, DayOfWeek) %>%
  summarise(count = n()) %>%
  mutate( weekend = ifelse(
    DayOfWeek == 'Saterday' | DayOfWeek == 'Sunday', 'weekend','weekday'))

rita.per_day_month$Month <- factor(rita.per_day_month$Month,
                 levels = c('01', '02', '03', '04', '05', '06', '07', '08', '09',
                            '10', '11', '12'), 
                 labels = c("January","February","March","April","May","June",
                            "July","August","September","October","November",
                            "December"))

ggplot(rita.per_day_month, aes(x = DayofMonth, y = count, color=weekend)) +
  geom_point() +
  facet_wrap(~ Month) +
  theme_bw() +
  theme(axis.text.x=element_blank())
````

Definitively, we see less flights during the weekend however, notice July and 
August (and also at the end of June) where this tendency seems to be opposite, the number of flights is higher the weekend versus the weekday.

## Best time in a day to travel

We can also show the best time in the day for traveling with a separation between 
weekday from weekend.
For this exercice we will select the year 2008 and the month of October.
This month has been selected because it has no known public holliday that may 
impact the visulization.

```{r, fig.width=10}
rita.per_hour <- subset(rita, Year > 1987)
rita.per_hour$CRSDepTime <- sprintf("%04d", rita.per_hour$CRSDepTime)
rita.per_hour$CRSDepTime <- strtrim(rita.per_hour$CRSDepTime, 2)

rita.per_hour <- rita.per_hour %>%
  group_by(Year, Month, DayofMonth, DayOfWeek, CRSDepTime) %>%
  summarise(count = n()) %>%
  mutate( weekend = ifelse(
    DayOfWeek == 'Saterday' | DayOfWeek == 'Sunday', 'weekend','weekday'))

ggplot(subset(rita.per_hour, Year == 2008 & Month == '10'), aes(x = CRSDepTime, y = count)) + 
  geom_boxplot(aes(fill=weekend)) +
  stat_summary(fun.y=mean, geom="line", aes(group=weekend, color = weekend))  + 
  stat_summary(fun.y=mean, geom="point", aes(color = weekend)) +
  theme_bw()
```

This plot is showing the fluctuations of the number of flights during a day, 
in particular the month of October 2008.
The lines are connecting the means respectively for the weekday and the weekends.

During the weekday, we clearly see that we have more flights at the begining of 
the day (6:00 and 7:00 AM) than it remain stable till 3:00 PM where we have a small 
drop.
Later arrount 6:00 PM, we again have a peak of flight but not as high as in the 
morning.

During the weekend, the peaks happen arround 9:00 AM and at 1:00 PM

We have almost no flight from midnight till 5:00 AM.

It also seems that we have more outlier data during the after-noon especially 
arround 2 pm.

This tendencies are repeating accross other months of the same year (not shown 
here)

## Taxi-in / Origin

Next, let's visualize the relationship between taxi-in and the origin.
Taxi indicates the movement of an aircraft on the ground.  Here we will analyse 
the taxiing immediately after the landing (taxi-in).

```{r, message=FALSE, warning=FALSE}
rita.taxi_in_origin <- filter(rita, !is.na(TaxiIn))
rita.taxi_in_origin <- tablefreq(rita[,c("TaxiIn","Origin")])
rita.taxi_in_origin <- head(arrange(rita.taxi_in_origin, -freq), n=100)

## Bar plot
ggplot(aes(x=TaxiIn, weight= freq), data = rita.taxi_in_origin, position ="dodge") + 
  geom_bar() +
  theme_bw()
```

For most of the flights, the taxiing time spent after landing is between 3 and 5
minutes.
Let's compute the relative frequencies and display the distribution of this value.

```{r, warning=FALSE}
rita.taxi_in_origin <- rita.taxi_in_origin %>% 
  group_by(Origin) %>%
  mutate( ngroup= sum(freq), wgroup= freq/ngroup)
  
ggplot(aes(x=TaxiIn, weight=wgroup),data = rita.taxi_in_origin) + 
  geom_density() +
  theme_bw()
```

From this last plot, we see 4 groups of flights emerging, each at 1 minutes interval.
Most of the flights are in the group of 4 and 5 minutes. 

## Destinations having the highest average delays

The objects of interest are the outliers, In this case we will only choose 
destinations with "average delay" higher than 15 minutes.

```{r}
rita.dest_highest_delays <- rita %>%
  group_by(Dest) %>%
  summarise(
    arr_delay = mean(ArrDelay, na.rm = TRUE),
    n = n()) %>%
  arrange(desc(arr_delay))

ggplot(rita.dest_highest_delays %>% filter(arr_delay > 15)) +
  geom_text(aes( x=arr_delay, y=n, label=Dest)) +
  theme_bw()
```

This plot is a bit messy but show some interesting facts.  Some destination 
airports (ORD, ATL, DFW) have very low average delay despit the number of fligh 
they accumulate but on the other hand, some airports (RDR) have very high 
average delay with very few flights.

## On average, how do delays (of non-cancelled flights) vary over the course of a day? 

We will analyse, only delays higher than 10 minutes.

```{r, message=FALSE, warning=FALSE}
rita.per_hour <- rita %>%
 filter(Cancelled == 'No' & !is.na(rita$AirTime)) %>%
 mutate(time = AirTime / 60) %>%
 group_by(time) %>%
 summarise(
    arr_delay = mean(ArrDelay, na.rm = TRUE),
    n = n()
 ) %>%
 filter(arr_delay > 10)

ggplot(filter(rita.per_hour, n > 30), aes(time, arr_delay)) +
  geom_point() +
  stat_smooth() +
  labs(x = "flight time in hours",
       y = "Delay (hours)") +  
  theme_bw()
```

As the flight time increase the arrival delay is increasing.  

The next last plot also show the density of flights (on a log scale).  As the 
time increase, we have less flights but interestingly, the delay increase 
significantly.

```{r}
ggplot(data = filter(rita.per_hour, n > 30)) +
  geom_point(aes(time, log10(arr_delay), size = n)) +
  scale_size_area() +
  coord_trans(y = "log10") +
  labs(x = "flight time in hours",
       y = "Delay (log)") +
  theme_bw()
```

## Delay per month

Let's visualize the delay over the months and see which months are better

In a table format, we can compute the delay per carrier for each months and 
visualize these data.  We will visualize the carrier with "average delay" 
higher than 15 minutes.

```{r}
rita.monthly_delay.wide <- rita %>% 
  mutate(month=Month, carrier=UniqueCarrier) %>% 
  group_by(month, carrier) %>% 
  summarize(delay=sum(ArrDelay, na.rm=T)) %>% 
  dcast(month ~ carrier, value.var = "delay")

#head(rita.monthly_delay.wide, 5)
```

```{r, fig.width=10, fig.height=8}
rita.monthly_delay <- rita %>% 
  mutate(month=Month, carrier=UniqueCarrier) %>% 
  group_by(month, carrier) %>% 
  summarize(delay=mean(ArrDelay, na.rm=T)) 

rita.monthly_delay$month <- factor(rita.monthly_delay$month,
                 levels = c('01', '02', '03', '04', '05', '06', '07', '08', '09',
                            '10', '11', '12'), 
                 labels = c("January","February","March","April","May","June",
                            "July","August","September","October","November",
                            "December"))
  
ggplot(NULL, aes(x=month, y=delay, fill=carrier, alpha=.2)) + 
  geom_bar(data=rita.monthly_delay %>% filter(delay > 15), 
           stat='identity',
           position = "identity",
           colour="black") + 
  geom_bar(data=rita.monthly_delay %>% filter(delay < 15), 
           stat='identity',
           position = "identity",
           colour="black") +
  labs(x = "Month",
       y = "Delay (minutes)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = .5, vjust=0.5))
```

This plot is not the best to display a trend because the coloring stacking is 
hidding things however we see that some airport are better in delay at the 
begining of the year and other at the end of the year.  So we start to see a 
seasonal effect in the delays.

# Logit (log odds) transformation

When the time is a continuous predictor it is sometimes interesting to use the 
logit transofrmation.

If values are naturally restricted to be in the range 0 to 1, not including 
the end-points, then a logit transformation may be appropriate.

A logit is the defined as the logarithm of the odds. If $p$ is the probability of 
an event, then $(1 – p)$ is the probability of not observing the event, and the 
odds of the event are $\frac{p}{(1 – p)}$. Hence, the logit is

$$
logit(p) = log \frac{p}{(1-p)}
$$

The logit is undefined when $p = 0$ or $p = 1.0$.  This is not a problem with 
because the logit transformation is applied to a predicted probability which
can be shown to always be greater than 0 and less than 1.0.

Here we visualize the logit transformation applied to the mean of delay (higher 
than 10 minutes) for each days of the dataset.

```{r}
# logit function
logit = function(p) log(p/(1-p))

# Proportion of flights delayed (by more than 15min) per date
rita.flight_delay_15 <- rita %>%
  group_by(Year, Month, DayofMonth) %>%
  summarise(proportion = mean(ArrDelay > 15, na.rm=TRUE))

# Group per month and year
rita.flight_delay_15_month <- rita.flight_delay_15 %>%
  group_by(Year, Month) %>%
  summarise(prop = mean(proportion, na.rm=TRUE))

# Transform the coordinate scale
inverse_logit_trans <- trans_new("inverse logit",
                                  transform = plogis,
                                  inverse = qlogis)

ggplot(na.omit(subset(rita.flight_delay_15)), 
       aes(x = as.Date(paste(Year, Month, DayofMonth, sep='-')), 
           y = logit(proportion))) +  
  geom_line(data = rita.flight_delay_15_month, 
            aes(x = as.Date(paste(Year, Month, 15, sep='-')), 
                y = logit(prop)),
            size = 1) +
  geom_point(color = 'orange', alpha = .2) +
  scale_x_date(labels = date_format("%Y")) + 
  coord_trans(ytrans = inverse_logit_trans) +    
  labs(x = "Date",
       y = "Probabilities") +
  theme_bw()
```

This last plot is showing the logit transofrmation applied for the arrival delay.

The black line show the average probablibilites per month.

We clearly see peaks and drops repeating year after year.

Let's visualize three consecutive years if we can see some seasonaibility effect.

```{r}
ggplot(na.omit(subset(rita.flight_delay_15, Year %in% c(2004, 2005))), 
       aes(x = as.Date(paste(Year, Month, DayofMonth, sep='-')), 
           y = logit(proportion))) +  
  geom_line(data = subset(rita.flight_delay_15_month, Year %in% c(2004, 2005)), 
            aes(x = as.Date(paste(Year, Month, 15, sep='-')), 
                y = logit(prop)),
            size = 1) +
  geom_point(color = 'orange', alpha = .4) +
  scale_x_date(labels = date_format("%b %Y")) + 
  coord_trans(ytrans = inverse_logit_trans) +    
  labs(x = "Date",
       y = "Probabilities") +
  theme_bw()
```

We see the drop in probabilities of arrival delays during the summer holliday 
(July, August) as well as at the end of the year (December, January).  This make 
sense, more people are traveling during summer and during the year-end celebrations.

Finally, we will use the logit function we've explored in the previous section 
to visually show the arrvival delays in a calendar view.

```{r, fig.height=8, fig.width=10, Calendar}
# Helper function : Function to return row/column for dates as in a calendar
calendar = function(date) {
  year = year(date)
  month = month(date)
  day = day(date)
  # Transforms dates stored in character and numeric vectors to POSIXct objects.
  first = ymd(paste(year, month, 1, sep='-')) 
  # The wday component of a POSIXlt object is the numeric weekday 
  # (0-6 starting on Sunday)
  wday_first = wday(first)
  offset = 5 + wday_first
  weekrow = ((day + offset) %/% 7) - 1
  daycol = (day + offset) %% 7
  cbind(weekrow, daycol)
}

# calendar with delays
temp = calendar( with(rita.flight_delay_15, paste(Year, Month, DayofMonth, sep='-')))
rita.flight_delay_15$weekrow = factor(temp[,1], levels=5:0, ordered=TRUE)
rita.flight_delay_15$daycol = factor(temp[,2], levels=0:6, ordered=TRUE)

# Preparing the final plot
p <- ggplot(rita.flight_delay_15, aes(daycol, weekrow, fill=logit(proportion)))
p <- p + geom_tile() + facet_grid(Month ~ Year)
p <- p + scale_fill_continuous(low='white', high='blue')
p <- p + theme_bw()
p <- p + theme(axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  legend.position='none')
p
```

We see similarly the same seasonality effect observed in the previous plot.
December, January, July and August are the months where the probability to have 
highest delay is the maximum.  We olso notice the very darks cells in September 
2001 reflecting the W.T.C. attacks.

# Final Plots and Summary

### Plot One

```{r, Plot_One}
location <- airports %>%
  select(Dest = iata, name = airport, lat, long)

rita.rita_full_dest <- rita %>%
  group_by(Dest) %>%
  filter(!is.na(ArrDelay)) %>%
  summarise(
    arr_delay = mean(ArrDelay),
    n = n()
  ) %>%
  arrange(desc(arr_delay)) %>%
  left_join(location)

# load the state data
data(state)
states <- data.frame(state.abb, state.name, state.area, state.center,
                     state.division, state.region, state.x77)

# Remove the data points out of the USA
maxLong <- max(states$x)
minLong <- min(states$x)
maxLat <- max(states$y)
minLat <- min(states$y)

rita.rita_full_dest <- subset(rita.rita_full_dest, 
                              long <= maxLong & 
                                long >= minLong & 
                                lat <= maxLat & 
                                lat >= minLat)

map <- map_data("state")
ggplot(data = map, aes(x = long, y = lat, group = group)) +
  # draw outlines of the state
  geom_polygon(fill="grey") + 
  geom_path(colour = '#8B7E66', linestyle = 2) + 
  coord_map() +
  geom_text(data = states, aes(x     = x, 
                               y     = y, 
                               label = state.abb,
                               group = NULL), 
            size = 4, 
            colour="black") +
  geom_point(data = rita.rita_full_dest, 
             aes(x = long, y = lat, colour = arr_delay, 
                 group = NULL), size = 2) +
  labs(colour = "Average arrival delay") +
  scale_colour_gradientn(breaks = c(0, 20, 40, 60, 80, Inf),
                         colours=rainbow(7)) +
  geom_text(aes(x = long, y = lat, label=Dest, group = NULL, colour = arr_delay), 
            data = subset(rita.rita_full_dest, 
                          rita.rita_full_dest$arr_delay >= 20), 
            hjust=-.1, fontface="italic", size=5) +
  ggtitle("Average delays in USA airport") +
  theme_bw() +
  theme(legend.position="bottom")
```
This plot show a map of the average arrival delay per airport in US.
The airport for which we see the dots in puprle are those having an average arrival 
delay of at least 20 minutes.  We notice that these airports are on the east of 
the map.  The airport with the code RDR (Grand Forks AFB) is having the highest 
average delay of 93 minutes.

The reasons why these airports are showing highest delay is not clear.  One reason
could be the impact of the weather conditions.  After some 
[investigation](http://en.wikipedia.org/wiki/Tornadoes_in_the_United_States), the 
tornados for example are more likely to happen on the south & east part of the USA.  

An other reason could be the highest number of flight deserving the east part of
the US.

### Plot Two

For this plot we will show the delay on a hourly arrival delay with various 
statistics.

```{r, fig.width=10, Plot_Two}
rita.flight_delay_plot_two <- rita %>%
  group_by(Year, Month, DayofMonth) %>%
  filter(!is.na(ArrDelay) & ArrDelay > 0 & ArrDelay < 1000) %>%
  summarise(
    mean = mean(ArrDelay / 60, na.rm=TRUE),
    lower = min(ArrDelay / 60, na.rm=TRUE),
    upper = max(ArrDelay / 60, na.rm=TRUE),
    quant.25 = quantile(ArrDelay / 60, na.rm=TRUE, 0.25),
    quant.75 = quantile(ArrDelay / 60, na.rm=TRUE, 0.75)   
  )

rita.flight_delay_plot_two_m <- rita %>%
  group_by(Year) %>%
  filter(!is.na(ArrDelay) & ArrDelay > 0 & ArrDelay < 1000) %>%
  summarise(
    mean = mean(ArrDelay / 60, na.rm=TRUE),
    lower = min(ArrDelay / 60, na.rm=TRUE),
    upper = max(ArrDelay / 60, na.rm=TRUE),
    quant.25 = quantile(ArrDelay / 60, na.rm=TRUE, 0.25),
    quant.75 = quantile(ArrDelay / 60, na.rm=TRUE, 0.75)   
  )

rita.flight_delay_plot_two  <- mutate(rita.flight_delay_plot_two,
       date = as.Date(paste(Year, Month, DayofMonth, sep='-')))

rita.flight_delay_plot_two_m  <- mutate(rita.flight_delay_plot_two_m,
       date = as.Date(paste(Year, 12, 31, sep='-')))

dottedYears <- seq(as.Date("1991/1/1"), 
                   as.Date("2008/1/1"), 
                   by = "5 year")

g.top <- ggplot(rita.flight_delay_plot_two) +
  geom_linerange(rita.flight_delay_plot_two, 
                 mapping=aes(
                   x=date, ymin=quant.25, ymax=quant.75), 
                 colour = "wheat4", size=5) +   
  geom_vline(xintercept = as.numeric(dottedYears), 
             color="wheat4", linetype=3, size=0.5) +  
  geom_line(data = rita.flight_delay_plot_two_m, 
            aes(x = date, 
                y = quant.75), color ="brown") +
  geom_line(data = rita.flight_delay_plot_two_m, 
            aes(x = date, 
                y = quant.25), color ="green") +
  theme(plot.margin = unit(c(1,5,-30,6),units="points"),
        axis.title.y = element_text(vjust =0.25),
        plot.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank()) +
  labs(y = "IQR (hour)") +
  annotate("text", 
           x=as.Date("2004/6/1"), 
           y=1, 
           label="Third quartile (75%)", 
           size=4, hjust = 0, color ="brown") +
  annotate("text", 
           x=as.Date("2004/6/1"), 
           y=0.4, 
           label="First quartile (25%)", 
           size=4, hjust = 0, color ="green")

g.bottom <- ggplot(rita.flight_delay_plot_two) +
  geom_linerange(rita.flight_delay_plot_two, 
                 mapping=aes(
                   x=date, ymin=lower, ymax=upper), 
                 colour = "wheat2", alpha=1, size=5) +
  geom_line(data = rita.flight_delay_plot_two_m, 
            aes(x = date, 
                y = upper), color ="brown") +
  geom_line(data = rita.flight_delay_plot_two_m, 
            aes(x = date, 
                y = mean), color ="green") +
  geom_vline(xintercept = as.numeric(dottedYears), 
             color="wheat4", linetype=3, size=0.5) +
  annotate("rect", 
           xmin=as.Date("2001/1/1"), 
           xmax=as.Date("2001/12/31"), 
           ymin=0, 
           ymax=Inf, alpha=0.2, fill="red") +
  annotate("rect", 
           xmin=as.Date("2002/1/1"), 
           xmax=as.Date("2002/12/31"), 
           ymin=0, 
           ymax=Inf, alpha=0.2, fill="blue") +
  scale_x_date(
    breaks = date_breaks("5 year"),
    labels = date_format("%Y")) +
  labs(x = "Year", y = "Min / Max Delay (hour)") +
  theme(plot.margin = unit(c(0,5,1,1),units="points"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank()) + 
  annotate("text", 
           x=as.Date("1987/5/1"), 
           y=15, 
           label="Data represents arrival delay per day for U.S.A.    ", 
           size=3, color="gray30", hjust = 0) + 
  annotate("text", 
           x=as.Date("1987/5/1"), 
           y=14, 
           label="from 1987 to 2008. Outer lighter at the bottom bands", 
           size=3, color="gray30", hjust = 0) +
  annotate("text", 
           x=as.Date("1987/5/1"), 
           y=13, 
           label="show the min/max delay in hours for every day and   ", 
           size=3, color="gray30", hjust = 0) + 
  annotate("text", 
           x=as.Date("1987/5/1"), 
           y=12, 
           label="inner darker at the top bands show the IQR          ", 
           size=3, color="gray30", hjust = 0) + 
  ggtitle("Delays in US airports") +
  theme(plot.title=element_text(face="bold",
                                hjust=.06,vjust=.3,
                                color="#3C3C3C",
                                size=20)) +
  annotate("text", 
           x=as.Date("1987/5/1"), 
           y=16.5, 
           label="In Hours                                            ", 
           size=4, fontface="bold", hjust = 0) + 
  geom_segment(aes(x = as.Date("2000/1/1"), 
                   y = 8, 
                   xend = as.Date("2001/9/11"), 
                   yend = 13),
               size = .5,
               color ="brown",
               arrow = arrow(length = unit(0.25, "cm"))) +
  annotate("text", 
           x=as.Date("1998/1/1"), 
           y=7, 
           label="9/11 W.T.C. Attacks", 
           size=4, fontface="bold", hjust = 0, color ="brown") +
  annotate("text", 
           x=as.Date("2004/6/1"), 
           y=17, 
           label="Max delay (per year)", 
           size=4, hjust = 0, color ="brown") +
  annotate("text", 
           x=as.Date("2004/6/1"), 
           y=1.5, 
           label="Mean of delay (per year)", 
           size=4, hjust = 0, color ="green")

## plot graphs and set relative heights
grid.arrange(g.top,g.bottom, heights = c(1/5, 4/5)) 
```

This plot is showing the increase of arrival delays (in hours) from multiple 
angles.  At the bottom, we see the max and min arrival delay.  
This information is shown as bars for every days and with a red/brun line for 
each year.  We see that the minimum delay is not really increasing or decreasing
from year to year but the maximum delay is on the other hand, increasing 
regularly.  We certainly see the highest increase when we left the 19th.

Still on the bottom, two areas are maked with different colors.  The red color show 
the year of the W.T.C attack and the blue area show the "recovery" year.  We can 
notice the pick in delays after 2001 probably due to a reinforcement of the 
security measure which has probably caused many delays.  Interestingly, 2001 is 
not the year where we had the highest delay.

Finally, the top part of the graph show the IQR.  The IQR is the difference 
between the upper and lower quartiles. In other words, the IQR is the 1st quartile subtracted from the 3rd. In red we draw the upper quartile (75%) calculated on 
a yearly basis and in green the lower quartile (25%) also calculated on a yearly
basis. This time, the increase is not really clear. We can than conclude that 
delays are not more or less frequent from year to year but certainly when we have 
delay, this delay is more important (as shown at the bottom).

### Plot Three

For the third plot we will try to visualize the impact of the September 11, 
2001 attacks on the flight volume for the busiest airport of USA in that 
year.  For that we will create a new dataset containing information about 5 
airports between July and December 2001.
For the selection of the airports we will take only the busiest airports by 
passenger in 2001 ([wikipedia link](http://en.wikipedia.org/wiki/List_of_the_world%27s_busiest_airports_by_passenger_traffic#2001_statistics)).  
These airports are :

- Hartsfield-Jackson Atlanta International Airport - Atlanta, Georgia - ATL
- O'Hare International Airport - Chicago, Illinois - ORD
- Los Angeles International Airport - Los Angeles, California - LAX
- Dallas-Fort Worth International Airport - Dallas/Fort Worth, Texas - DFW
- Denver International Airport - Denver, Colorado - DEN

```{r eval=FALSE}
file.name <- paste(2001, "csv.bz2", sep = ".")
if (!file.exists(file.name)) {
  url.text <- paste("http://stat-computing.org/dataexpo/2009/", 2001, ".csv.bz2",
  sep = "")
  cat("Downloading missing data file ", file.name, "nn", sep = "")
  download.file(url.text, file.name)
}
```

```{r eval=FALSE}
rita_2001 <- read.csv("2001.csv")
# we take the destination airports of interest
rita_2001 <- subset(rita_2001, Dest %in% c('ATL', 'ORD', 'LAX', 'DFW', 'DEN'))
# we take the data from July to December
rita_2001 <- subset(rita_2001, Month %in% c(7, 8, 9, 10, 11, 12))
write.csv(rita_2001, "rita_2001_busy.csv", row.names=FALSE, na="")
```

```{r, fig.height=8, fig.width=10, Plot_Three}
rita_2001 <- read.csv("rita_2001_busy.csv")

rita_2001$Month <- sprintf("%02d", rita_2001$Month)
rita_2001$DayofMonth <- sprintf("%02d", rita_2001$DayofMonth)

# full date of the departure
rita_2001 <- mutate(rita_2001, 
                    date = as.Date(paste(rita_2001$Year, rita_2001$Month, 
                                         rita_2001$DayofMonth, sep=""), 
                                   "%Y%m%d"))

rita_2001.rita_2001_per_day <- rita_2001 %>%
  group_by(date, Dest) %>%  
  filter(!is.na(ArrDelay)) %>%
  summarise(
    arr_delay = mean(ArrDelay),
    n = n()
  ) %>%
  arrange(date, Dest) %>%
  left_join(location)

ggplot(rita_2001.rita_2001_per_day) +
  geom_line(aes(x=date, y=n, col=name), size = 1) +
  geom_vline(aes(xintercept=as.numeric(as.Date("2001-09-11"))), 
             color="wheat4", linetype=3, size=0.5) +
  annotate("rect", 
           xmin=as.Date("2001/9/11"), 
           xmax=as.Date("2001/9/19"), 
           ymin=0, 
           ymax=Inf, alpha=0.2, fill="blue") +
  geom_text(aes(x=as.Date("2001-09-20"), 
                label="Sep `01 - W.T.C. Attack", y=950, hjust = 0), 
            colour="grey", angle=0, text=element_text(size=11)) +
  xlab("Month") +
  ylab("Flight volume") +
  ggtitle("Volume at major Airports, impact of the WTC attack") +
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(colour = "black", linetype = 3, size = .5),
    panel.background = element_blank(),
    axis.title.x = element_text(size=16),
    axis.text.x = element_text(size=14, angle=45, hjust=1, vjust=1),
    axis.title.y = element_text(size=16, angle = 90),
    axis.text.y = element_text(size=14),
    strip.background = element_rect(color="white", fill="white"),
    strip.text = element_text(size=16),
    legend.position="bottom",
    legend.direction = "vertical"
  )

```

This plot show the change in major airports daily flight volume after WTC attacks.  
We clearly see the drop on the 9/11.  The recovery of the flight volume has been 
almost immediate once the flight traffic has been re-opened after the event but 
not at the same level as before the attacks.  

We can notice how in Chicago for example, the volume dropped from 1000 to 50 
after September 11th and only recovered to 700 once the traffic has been 
re-established.

The blue area show the recovery area from the 11th to the 19th.  Almost a week 
was necessay to re-established a proper flight traffic.

An other element to notice is the uneven effect visible for each airport.  This 
is the effect of the weekend/seasonality which drop the number of flights.

# Reflection

I was interested in analyzing this particular set of data. First because it is 
an accessible piece of information which does not require any background domain 
knowledge in order to run an analysis.  Second, the very large volume of data 
was a very good chalange to me.  I spent a lot of time just loading, parsing and
creating a usable dataset in R studio.

I struggled a bit at first with exactly what I expected to learn from this 
dataset.  However, I did a lot of quick coding to reveal some interesting 
information about the data.

The analysis performed reveal some obvious and non obvious trend in the data but
many times I was a bit confused about how to interpret the findings.  There are 
several variables not included as an explanatory or response variable in the 
dataset but can affect the interpretation of relationships between variables 
(lurking variable).  For example, the aircraft maintenance, the staffing, ...  
All these features may impact the delay of a flight.

The various regression model I tried to implement was not really conclusive, 
especially when I try to fit a linear model to each day, predicting delay from 
time of day.  The nature of the data did not reveal obvious correlation.

I was pleased with how easy it is to produce a simple map of the world in R. 
And plotting points and lines was easy and straight forward.

It really helped to just systematically go through each variable with some quick 
and dirty plots and see what the data showed me. There is still much to be 
learned from this dataset, and more questions to find and answer.  For example :

- Do older planes suffer more delays?
- How does the number of people flying between different locations change over 
time?
- How well does weather predict plane delays?
- Can you detect cascading failures as delays in one airport create delays in 
others? Are there critical links in the system?

This has really helped me flesh out my varied interests in data analytics. 
I look forward to analyzing more intriguing datasets in the future, and hope 
you found some of the insights into this dataset as interesting as I did.

# References

* A useful book full of tehniques to manipulate data with R : 
[Wrangling F1 Data With R](https://leanpub.com/wranglingf1datawithr)
* The reference dataset : 
[RITA data](http://stat-computing.org/dataexpo/2009/the-data.html)
* Article about how to draw good looking maps in R : 
[Maps in R](https://uchicagoconsulting.wordpress.com/tag/r-ggplot2-maps-visualization/)
* Stackoverflow issue : 
[Administrative regions map of a country with ggmap and ggplot2](http://stackoverflow.com/questions/17723822/administrative-regions-map-of-a-country-with-ggmap-and-ggplot2)
* Wikipedia article :
[Data transformation](http://en.wikipedia.org/wiki/Data_transformation_%28statistics%29)
* Wikipedia article :
[Logit](http://en.wikipedia.org/wiki/Logit)
* Wikipedia article : [Odds ratio](http://en.wikipedia.org/wiki/Odds_ratio)
* Article : [Double plots and two axes](http://steffi.ca/thinkR/?p=91)
* Tool : [Color advice for catography](http://colorbrewer2.org/#)